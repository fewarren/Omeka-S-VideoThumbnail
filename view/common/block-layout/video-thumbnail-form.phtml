<?php
$mediaId = isset($mediaId) ? $mediaId : null;
$mediaTitle = isset($mediaTitle) ? $mediaTitle : '';
$framePercent = isset($framePercent) ? (int)$framePercent : 10;

// Add our script and ensure it runs after Omeka's scripts
$this->headScript()->appendFile($this->assetUrl('js/video-thumbnail-block-admin.js', 'VideoThumbnail'));
$this->headLink()->appendStylesheet($this->assetUrl('css/video-thumbnail.css', 'VideoThumbnail'));
?>

<!-- DEBUG BANNER - REMOVE IN PRODUCTION -->
<div style="background:#e6f7ff; border:2px solid #0088cc; padding:10px; margin:10px 0; font-size:14px; line-height:1.4; border-radius:5px;">
    <h3 style="color:#0088cc; margin-top:0;">Video Thumbnail Block (Debug v2.2.0)</h3>
    <p>This block allows you to select a video and use its thumbnail. The current selection is:</p>
    <ul style="margin-bottom:0;">
        <li><strong>Media ID:</strong> <?= $mediaId ? $mediaId : 'None selected' ?></li>
        <li><strong>Media Title:</strong> <?= $mediaTitle ? $this->escapeHtml($mediaTitle) : 'None' ?></li>
        <li><strong>Frame Position:</strong> <?= $framePercent ?>%</li>
        <li><strong>Template Time:</strong> <?= date('Y-m-d H:i:s') ?></li>
    </ul>
</div>

<div class="video-thumbnail-form-container">
    <div class="field">
        <div class="field-meta">
            <label><?= $this->translate('Video Media') ?></label>
            <div class="field-description"><?= $this->translate('Select a video to display its thumbnail') ?></div>
        </div>
        <div class="inputs">
            <input type="hidden" name="o:block[__blockIndex__][o:data][media_id]" value="<?= $this->escapeHtml($mediaId) ?>" class="media-id">
            
            <div class="value">
                <span class="selected-resource">
                    <?= $mediaTitle ? $this->escapeHtml($mediaTitle) : $this->translate('No media selected') ?>
                </span>
            </div>
            
            <!-- STANDARD OMEKA RESOURCE SELECTION PATTERN -->
            <div class="resource-select" data-sidebar-content-url="<?= $this->escapeHtml($this->url('admin/default', ['controller' => 'media', 'action' => 'sidebar-select'])) ?>">
                <a href="#" class="select-resource button">
                    <?= $this->translate('Select Video') ?>
                </a>
                <?php if ($mediaId): ?>
                <a href="#" class="remove-resource button">
                    <?= $this->translate('Clear') ?>
                </a>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <div class="field">
        <div class="field-meta">
            <label><?= $this->translate('Thumbnail Frame Position (%)') ?></label>
            <div class="field-description"><?= $this->translate('Position in the video to use for the thumbnail (0-100%)') ?></div>
        </div>
        <div class="inputs">
            <input type="number" 
                   name="o:block[__blockIndex__][o:data][frame_percent]" 
                   value="<?= $this->escapeHtml($framePercent) ?>" 
                   min="0" 
                   max="100" 
                   class="frame-percent">
        </div>
    </div>
</div>

<!-- Optional but helpful: inline JavaScript -->
<script>
$(document).ready(function() {
    console.log("Video Thumbnail Block Debug - Template loaded");
    
    // Add click handler for the select button
    $('.select-resource').click(function(e) {
        e.preventDefault();
        console.log("Select button clicked");
        
        var container = $(this).closest('.resource-select');
        var sidebarUrl = container.data('sidebar-content-url');
        
        console.log("Opening sidebar with URL: " + sidebarUrl);
        Omeka.openSidebar(sidebarUrl);
        
        // Setup sidebar callback
        Omeka.mediaSidebar = {
            selectedMedia: function(id, title) {
                console.log("Media selected - ID: " + id + ", Title: " + title);
                
                // Find the form field elements
                var block = container.closest('.video-thumbnail-form-container');
                var mediaInput = block.find('.media-id');
                var titleDisplay = block.find('.selected-resource');
                
                // Update the values
                mediaInput.val(id);
                titleDisplay.text(title || id);
                
                // Add remove button if not present
                if (container.find('.remove-resource').length === 0) {
                    $('<a href="#" class="remove-resource button"><?= $this->translate('Clear') ?></a>')
                        .appendTo(container);
                }
                
                // Close sidebar
                Omeka.closeSidebar();
                
                // Update the debug info
                $('.debug-media-id').text(id ? id : 'None selected');
                $('.debug-media-title').text(title ? title : 'None');
            }
        };
    });
    
    // Handle remove button clicks
    $(document).on('click', '.remove-resource', function(e) {
        e.preventDefault();
        console.log("Remove button clicked");
        
        var container = $(this).closest('.resource-select');
        var block = container.closest('.video-thumbnail-form-container');
        var mediaInput = block.find('.media-id');
        var titleDisplay = block.find('.selected-resource');
        
        // Clear values
        mediaInput.val('');
        titleDisplay.text('<?= $this->translate('No media selected') ?>');
        
        // Remove the button
        $(this).remove();
        
        // Update debug info
        $('.debug-media-id').text('None selected');
        $('.debug-media-title').text('None');
    });
});
</script>