# Change Log

## 3.0.97 - 2025-05-01
### Fixed
- Fixed service not found error for Omeka\File\Manager:
  - Changed service dependency from 'Omeka\File\Manager' to 'Omeka\File\Store'
  - Implemented fallback thumbnail generation for systems without FileManager
  - Added manual thumbnail creation with proper image scaling and cropping
  - Updated all service factories to use the correct service names
  - Added robust error handling for service availability issues

## 3.0.96 - 2025-05-01
### Security
- Fixed command injection vulnerability in exec() calls:
  - Replaced unsafe concatenation of escapeshellcmd() with proper sprintf() and escapeshellarg()
  - Improved handling of Windows paths with spaces (e.g., "Program Files")
  - Added security comments to clarify the proper shell command handling
  - Ensured all command arguments are properly quoted

## 3.0.95 - 2025-05-01
### Fixed
- Fixed re-instantiation of heavy services by using service manager:
  - Updated ThumbnailSynchronizer to get VideoFrameExtractor from service manager
  - Modified Module.php to use service manager for VideoFrameExtractor
  - Added service locator access to file manager in ThumbnailSynchronizerFactory
  - Implemented fallback mechanisms for backwards compatibility
  - Improved logging for service instantiation issues

## 3.0.94 - 2025-05-01
### Fixed
- Fixed CSRF validation to use dynamically determined element name:
  - Replaced hardcoded 'csrf' check with dynamic lookup of CSRF element
  - Now works correctly with any CSRF element name generated by Laminas
  - Added fallback handling if CSRF element is missing
  - Added detailed logging for CSRF validation issues

## 3.0.93 - 2025-05-01
### Fixed
- Fixed route pattern for 'video-thumbnail-media' to make action segment optional:
  - Changed route from '/video-thumbnail/media/:id/:action' to '/video-thumbnail/media/:id[/:action]'
  - Maintains default 'index' action when action segment is omitted
  - Prevents 404 errors when calling the route without an action segment
  - Follows standard Omeka S routing patterns for optional segments

## 3.0.92 - 2025-05-01
### Fixed
- Fixed TempFile misuse that prevented thumbnail persistence:
  - Replaced direct TempFile::setStorageId() and storeThumbnails() calls
  - Updated FileManagerDelegatorFactory to use correct File\Manager service
  - Implemented proper thumbnail creation via FileManager in controllers
  - Fixed ThumbnailSynchronizer to work with Omeka's file system properly
  - Added graceful fallbacks for thumbnail generation
  - Added additional validation and error handling

## 3.0.91 - 2025-04-30
### Improved
- Replaced direct error_log() calls with PSR-3 compatible logger injection:
  - Added LoggerAwareTrait for standardized logger implementation
  - Created LoggerFactory for PSR-3 compatible logging
  - Updated service factories to inject loggers
  - Added contextual logging with metadata
  - Created README-LOGGING.md documentation
  - Improved error reporting and troubleshooting

## 3.0.90 - 2025-04-29
### Security
- Added comprehensive input validation for all method parameters:
  - Implemented type checking and boundary validation in VideoFrameExtractor
  - Added parameter validation in controller methods
  - Enhanced validation in controller plugins
  - Improved error handling for invalid input data
  - Added validation for file paths, media IDs, and time positions

## 3.0.89 - 2025-04-29
### Changed
- Modified default configuration settings for production environments:
  - Set debug.enabled to false by default
  - Reduced memory.limit from 1024M to 512M
  - Reduced memory.gc_probability from 100 to 10
- Updated README with production environment recommendations
- Enhanced TROUBLESHOOTING.md with memory and performance optimization guidance

## 3.0.88 - 2025-04-28
### Fixed
- Fixed "Undefined array key 'debug'" in FileManagerDelegatorFactory.php
- Fixed form validation errors when saving module settings
- Fixed "Undefined variable $thumbnailHtml" in video-thumbnail-form.phtml
- Consolidated debug settings in module.config.php
- Improved error handling and debug logging

# Video Thumbnail Module Improvements

## Overview

This document outlines improvements made to the VideoThumbnail module during our Claude Code session, focused on fixing two key issues:
1. Preventing multiple media attachments in a single VideoThumbnail block
2. Resolving the "No video thumbnail available" error message when thumbnails fail to generate

## Key Changes

### 1. Limiting Video Thumbnail Blocks to a Single Media Item

Added configuration to restrict blocks to using just one media item:

```php
// In the blockAttachmentsForm call:
[
    'limit' => 1, // Only allow one attachment - critical for proper operation
    'mediaTypes' => ['video'] // Further restrict to only video media types
]
```

### 2. Multiple Attachment Cleanup

Added code to remove any extra attachments:

```php
// If there were multiple attachments, remove all but the valid one
if (count($attachments) > 1 && $validAttachment) {
    // Create a new ArrayCollection with just the valid attachment
    $newAttachments = new \Doctrine\Common\Collections\ArrayCollection();
    $newAttachments->add($validAttachment);
    
    // Replace the block's attachments with our single-item collection
    $block->setAttachments($newAttachments);
    $this->log("Removed extra attachments, keeping only media ID {$mediaId}", 'info');
}
```

### 3. Enhanced WebM File Support

Added special handling for WebM video files that often cause thumbnail issues:

```php
// Check if this is a webm file and use appropriate settings
$mediaType = '';
if (method_exists($media, 'getMediaType')) {
    $mediaType = $media->getMediaType();
} else if (method_exists($media, 'mediaType')) {
    $mediaType = $media->mediaType();
}

$isWebm = (strpos($mediaType, 'video/webm') !== false || 
           (strpos($originalFilePath, '.webm') !== false));

// For webm files, we need to use specific ffmpeg options for better compatibility
if ($isWebm) {
    self::debugLog("Processing webm video with special options", $entityManager);
    error_log("VideoThumbnail: Processing webm video with special options");
    $cmd = escapeshellcmd($ffmpegPath) . " -ss $time -i " . escapeshellarg($originalFilePath) . 
           " -frames:v 1 -q:v 2 -pix_fmt yuv420p -vf 'scale=trunc(iw/2)*2:trunc(ih/2)*2' " . 
           escapeshellarg($outputPath);
}
```

### 4. Better FFmpeg Error Detection

Improved error detection and logging for FFmpeg command execution:

```php
// Log the complete output from FFmpeg for debugging
error_log("VideoThumbnail: FFmpeg complete output: " . print_r($output, true));
self::debugLog("FFmpeg complete output: " . print_r($output, true), $entityManager);

if ($returnVar !== 0 || !file_exists($outputPath)) {
    self::logError("FFmpeg failed for media ID {$media->getId()} (cmd: $cmd)");
    error_log("VideoThumbnail: ERROR - FFmpeg failed for media ID {$media->getId()}, return code: {$returnVar}");
    
    // Check common issues with FFmpeg
    $outputStr = implode(' ', $output);
    if (strpos($outputStr, 'not found') !== false) {
        error_log("VideoThumbnail: FFmpeg reports file not found - this may be a permissions issue");
    } else if (strpos($outputStr, 'Invalid data found') !== false) {
        error_log("VideoThumbnail: FFmpeg reports invalid data - this video may be corrupt or have unsupported codec");
    }
    
    return false;
}
```

### 5. Multiple Thumbnail Position Attempts

Implemented a fallback system that tries multiple positions in the video when thumbnail extraction fails:

```php
// For webm files, try multiple thumbnails at different times if needed
$attempts = $isWebm ? 3 : 1;
$success = false;

for ($i = 1; $i <= $attempts && !$success; $i++) {
    $attemptPercent = $percent;
    if ($isWebm && $i > 1) {
        // For additional attempts, try different positions
        $attemptPercent = $i == 2 ? 25 : 75;
        error_log("WebM retry attempt #$i, using percent: $attemptPercent");
    }
    
    $success = \VideoThumbnail\Media\Ingester\VideoThumbnail::extractAndSaveThumbnail(
        $mediaEntity, $attemptPercent, $ffmpegPath, $entityManager
    );
    
    if ($success) {
        error_log("Thumbnail generation successful on attempt #$i");
        break;
    }
}
```

### 6. Verified Thumbnail URL Passing

Improved the template rendering by passing a verified thumbnail URL directly:

```php
// Now that we're sure we have a media and thumbnail, render the partial
$result = $view->partial('common/block-layout/video-thumbnail', [
    'media' => $media,
    'data' => $block->data(),
    'site' => $site,
    'block' => $block,
    // Pass the verified thumbnail URL directly to the template
    'verified_thumbnail_url' => $thumbnailUrl
]);
```

## References from Derivative Media Module

These changes were inspired by the approach taken in the [Derivative Media Module](https://github.com/Daniel-KM/Omeka-S-module-DerivativeMedia), which implements more comprehensive derivative handling with:

1. Better service management
2. More robust file path resolution
3. Multiple fallback mechanisms for media handling
4. Comprehensive error detection and reporting

## Integration Notes

Since the repository has been completely restructured with a new architecture, these changes will need to be manually integrated into the appropriate components of the new structure:

- The WebM handling should go into the video processing service
- The attachment limitation should be added to the block layout configuration
- The multiple position attempts should be integrated with the frame extraction service
- Error detection improvements should be added to the logging system

As the new architecture appears to use dedicated services and better separation of concerns, these changes should be distributed accordingly rather than being directly copied.